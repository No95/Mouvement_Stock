<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_606284_stock_mov.StockMovementUtils</api_name>
        <caller_access>1</caller_access>
        <client_callable>false</client_callable>
        <description>utility for managing stock movements</description>
        <mobile_callable>false</mobile_callable>
        <name>StockMovementUtils</name>
        <sandbox_callable>false</sandbox_callable>
        <script><![CDATA[var StockMovementUtils = Class.create();
StockMovementUtils.prototype = {
    initialize: function() {},

    createRecMovementStock: function(pol, rsl, qty, type) {
        var TYPE_MVT = 'u_entry';
        var ORIGIN_RECEPT = 'u_supplier_reception';


        var mvtstk = new GlideRecord('x_606284_stock_mov_x_606284_movstock');
        mvtstk.initialize();
        mvtstk.u_type_movement = TYPE_MVT;
        mvtstk.u_origin_movement = ORIGIN_RECEPT;
        //rs.purchase_order = po.sys_id;
        mvtstk.u_model = pol.model;
        mvtstk.u_stock = rsl.receiving_slip.stockroom;
        //mvtstk.insert();

        var po = new GlideRecord('proc_po');
        po.get(pol.purchase_order);

        var asset = new GlideRecord('alm_asset');
        asset.addQuery('purchase_line', pol.sys_id);
        asset.addQuery('receiving_line', rsl.sys_id);

        asset.query();
        gs.log("CrÃ©ation de mouvement de stock pour l'asset de type " + type, "StockMovementUtils");

        while (qty > 0) {
            if (asset.next()) {

                if (type == 'hardware' || type == 'asset') {
                    mvtstk.u_quantity = 1;
                    qty--;
                } else {
                    mvtstk.u_quantity = qty;
                    qty = 0;
                }
                mvtstk.u_asset = asset.sys_id;
                gs.log("Le Sys ID de l'asset est le " + mvtstk.u_asset, "StockMovementUtils");
                mvtstk.insert();

            }
        }
    },

    createRecVendorMovementStock: function(pol, rsl, asset) {
        var TYPE_MVT = 'u_entry';
        var ORIGIN_RECEPT = 'u_supplier_reception';

        var mvtstk = new GlideRecord('x_606284_stock_mov_x_606284_movstock');
        mvtstk.initialize();

        mvtstk.u_asset = asset.sys_id;

        // Purchase Order Line for Product Catalog
        var politem = new GlideRecord('proc_po_item');
        politem.get(pol);

        // Receiving Slip Line for Received Date
        var rslitem = new GlideRecord('proc_rec_slip_item');
        rslitem.get(rsl);

        // Receiving Slip for Receiving Stock
        var rcs = new GlideRecord('proc_rec_slip');
        rcs.get(rslitem.receiving_slip);

        mvtstk.u_type_movement = TYPE_MVT;
        mvtstk.u_origin_movement = ORIGIN_RECEPT;
        mvtstk.u_model = asset.model;
        // mvtstk.u_quantity = asset.quantity;
        mvtstk.u_stock = rcs.stockroom;
        mvtstk.u_date_movement = rslitem.received;
        mvtstk.u_product_catalog = politem.product_catalog;
		mvtstk.u_vendor = politem.vendor;
		mvtstk.u_rcllinevendor = rsl.sys_id;

        // Type d'asset
		if(asset.sys_class_name == 'alm_hardware') {
			mvtstk.u_assettype = "u_hardware";
			mvtstk.u_quantity = asset.quantity;
		}
		else if(asset.sys_class_name == 'alm_license') {
			mvtstk.u_assettype = "u_software";
			mvtstk.u_quantity = asset.rights;
		}
		else if(asset.sys_class_name == 'alm_consumable') {
			mvtstk.u_assettype = "u_consumable";
		}
		else {
			mvtstk.u_assettype = "u_other";
		}

		/* var AssetClass = asset.sys_class_name;
        switch (AssetClass) {
            case 'alm_hardware':
                mvtstk.u_assettype = "u_hardware";
                break;
            case 'alm_consumable':
                mvtstk.u_assettype = "u_consumable";
                break;
            case 'alm_license':
                mvtstk.u_assettype = "u_software";
                break;
            default:
                mvtstk.u_assettype = "u_other";
        } */

        mvtstk.insert();
    },

    createRecConsumableMovementStock: function(pol, rs, qty, receivedate, rclid) {
        var TYPE_MVT = 'u_entry';
        var ORIGIN_RECEPT = 'u_supplier_reception';

        var mvtstk = new GlideRecord('x_606284_stock_mov_x_606284_movstock');
        mvtstk.initialize();

        mvtstk.u_assettype = "u_consumable";;

        // Purchase Order Line for Product Catalog, Product Model and Vendor
        var politem = new GlideRecord('proc_po_item');
        politem.get(pol);

        // Receiving Slip for Receiving Stock
        var rcs = new GlideRecord('proc_rec_slip');
        rcs.get(rs);

        mvtstk.u_type_movement = TYPE_MVT;
        mvtstk.u_origin_movement = ORIGIN_RECEPT;
        mvtstk.u_model = politem.model;
        mvtstk.u_quantity = qty;
        mvtstk.u_stock = rcs.stockroom;
        mvtstk.u_date_movement = receivedate;
        mvtstk.u_product_catalog = politem.product_catalog;
		mvtstk.u_vendor = politem.vendor;
		mvtstk.u_rcllinevendor = rclid;		

        // Search Asset Consumable for this receipt.
		var asset = new GlideRecord('alm_consumable');
		asset.addQuery('model', politem.model);
        asset.addQuery('install_status', '6');
        asset.addQuery('substatus', 'available');
        asset.addQuery('stockroom', rcs.stockroom);
        asset.query();
        if (asset.next()){
            mvtstk.u_asset = asset.sys_id;
		}

        mvtstk.insert();
    },

    type: 'StockMovementUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>BL62F3EN</sys_created_by>
        <sys_created_on>2025-07-06 10:42:10</sys_created_on>
        <sys_id>5bbcdc8283a66e1048d6ccc6feaad3f1</sys_id>
        <sys_mod_count>22</sys_mod_count>
        <sys_name>StockMovementUtils</sys_name>
        <sys_package display_value="stock movement" source="x_606284_stock_mov">378f720b835a6a9048d6ccc6feaad37c</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="stock movement">378f720b835a6a9048d6ccc6feaad37c</sys_scope>
        <sys_update_name>sys_script_include_5bbcdc8283a66e1048d6ccc6feaad3f1</sys_update_name>
        <sys_updated_by>BL62F3EN</sys_updated_by>
        <sys_updated_on>2025-11-06 14:49:47</sys_updated_on>
    </sys_script_include>
</record_update>
